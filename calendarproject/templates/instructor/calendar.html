{% extends "layouts/index.html" %}

{% block title %}Kalendarz Instruktora{% endblock %}

{% block head %}
<!-- Jeśli używasz Tailwind CSS, upewnij się, że jest załadowany tutaj -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
{% endblock %}

{% block body %}
<!-- Przeniesienie stylów do body -->
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    .h-screen{
        height:92vh;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    /* Upewnij się, że kalendarz zajmuje pełną wysokość i szerokość */
    #calendar {
        flex: 1 1 auto;
        width: 100% !important;
        min-width: 800px;
        max-width: 100%;
    }

    /* Zapobieganie zmianie szerokości kalendarza */
    .fc {
        width: 100% !important;
        height: 100% !important;
    }

    .fc-view-harness {
        width: 100% !important;
    }

    /* Style dla modali */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .custom-modal .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #e0e0e0;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
        from {opacity: 0; transform: translateY(-20px);}
        to {opacity: 1; transform: translateY(0);}
    }

    .modal-title {
        margin-top: 0;
        color: #333;
        font-weight: bold;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .time-selector {
        margin: 10px 0;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
        gap: 10px;
    }

    .modal-buttons button {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-cancel {
        background-color: #f1f1f1;
        color: #333;
    }

    .btn-cancel:hover {
        background-color: #e0e0e0;
    }

    .btn-confirm {
        background-color: #4CAF50;
        color: white;
    }

    .btn-confirm:hover {
        background-color: #3d9140;
    }

    .confirmation-message {
        margin-bottom: 20px;
        font-size: 16px;
        line-height: 1.5;
    }

    .date-time-info {
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        margin: 15px 0;
        border-left: 4px solid #4CAF50;
    }

    /* Style dla powiadomień */
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: 500;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        z-index: 1500;
        transition: all 0.3s;
        animation: slideInRight 0.3s forwards;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .notification.success {
        background-color: #4CAF50;
    }

    .notification.error {
        background-color: #f44336;
    }
</style>

<!-- Linki do FullCalendar CSS i JS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.css' rel='stylesheet'/>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/locales/pl.js'></script>

<div class="h-screen w-full flex flex-col">
    <header class="bg-gray-800 text-white p-4">
        <h2 class="text-2xl font-bold">Kalendarz Instruktora</h2>
    </header>
    <main class="flex-1 overflow-hidden w-full">
        <div id='calendar' class="h-full w-full"></div>
    </main>
</div>

<!-- Modal do wyboru godzin -->
<div id="timeSelectModal" class="custom-modal">
    <div class="modal-content">
        <h2 class="modal-title text-xl">Wybierz godziny spotkania</h2>
        <p id="selectedDate" class="mb-3"></p>

        <div class="time-selector">
            <label for="startTime" class="block mb-2 font-medium">Godzina rozpoczęcia:</label>
            <select id="startTime"
                    class="w-full p-2 border rounded focus:ring-2 focus:ring-green-300 focus:border-green-500 outline-none">
                <option value="08:00">08:00</option>
                <option value="08:30">08:30</option>
                <option value="09:00">09:00</option>
                <option value="09:30">09:30</option>
                <option value="10:00">10:00</option>
                <option value="10:30">10:30</option>
                <option value="11:00">11:00</option>
                <option value="11:30">11:30</option>
                <option value="12:00">12:00</option>
                <option value="12:30">12:30</option>
                <option value="13:00">13:00</option>
                <option value="13:30">13:30</option>
                <option value="14:00">14:00</option>
                <option value="14:30">14:30</option>
                <option value="15:00">15:00</option>
                <option value="15:30">15:30</option>
                <option value="16:00">16:00</option>
                <option value="16:30">16:30</option>
                <option value="17:00">17:00</option>
                <option value="17:30">17:30</option>
                <option value="18:00">18:00</option>
                <option value="18:30">18:30</option>
                <option value="19:00">19:00</option>
                <option value="19:30">19:30</option>
            </select>
        </div>

        <div class="time-selector">
            <label for="endTime" class="block mb-2 font-medium">Godzina zakończenia:</label>
            <select id="endTime"
                    class="w-full p-2 border rounded focus:ring-2 focus:ring-green-300 focus:border-green-500 outline-none">
                <option value="08:30">08:30</option>
                <option value="09:00">09:00</option>
                <option value="09:30">09:30</option>
                <option value="10:00">10:00</option>
                <option value="10:30">10:30</option>
                <option value="11:00">11:00</option>
                <option value="11:30">11:30</option>
                <option value="12:00">12:00</option>
                <option value="12:30">12:30</option>
                <option value="13:00">13:00</option>
                <option value="13:30">13:30</option>
                <option value="14:00">14:00</option>
                <option value="14:30">14:30</option>
                <option value="15:00">15:00</option>
                <option value="15:30">15:30</option>
                <option value="16:00">16:00</option>
                <option value="16:30">16:30</option>
                <option value="17:00">17:00</option>
                <option value="17:30">17:30</option>
                <option value="18:00">18:00</option>
                <option value="18:30">18:30</option>
                <option value="19:00">19:00</option>
                <option value="19:30">19:30</option>
                <option value="20:00">20:00</option>
            </select>
        </div>

        <div class="modal-buttons">
            <button id="cancelButton" class="btn-cancel">Anuluj</button>
            <button id="confirmButton" class="btn-confirm">Potwierdź</button>
        </div>
    </div>
</div>

<!-- Modal potwierdzenia dodania terminu -->
<div id="confirmationModal" class="custom-modal">
    <div class="modal-content">
        <h2 class="modal-title text-xl">Potwierdź dodanie terminu</h2>

        <p class="confirmation-message">Czy chcesz dodać nowy termin w następującym czasie?</p>

        <div class="date-time-info" id="appointmentDetails"></div>

        <div class="modal-buttons">
            <button id="cancelAppointmentButton" class="btn-cancel">Anuluj</button>
            <button id="confirmAppointmentButton" class="btn-confirm">Dodaj termin</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var timeSelectModal = document.getElementById('timeSelectModal');
        var selectedDateEl = document.getElementById('selectedDate');
        var startTimeSelect = document.getElementById('startTime');
        var endTimeSelect = document.getElementById('endTime');
        var cancelButton = document.getElementById('cancelButton');
        var confirmButton = document.getElementById('confirmButton');

        // Zmienne do przechowywania danych terminu przed dodaniem
        var appointmentToAdd = null;
        var confirmationModal = document.getElementById('confirmationModal');
        var appointmentDetailsEl = document.getElementById('appointmentDetails');
        var cancelAppointmentButton = document.getElementById('cancelAppointmentButton');
        var confirmAppointmentButton = document.getElementById('confirmAppointmentButton');

        // Zmienna do przechowywania wybranej daty
        var selectedDate = null;

        // Funkcja do pokazywania modalu potwierdzenia
        function showConfirmationModal(info) {
            appointmentToAdd = info;

            var startDate = info.start.toLocaleDateString('pl-PL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            var startTime = info.start.toLocaleTimeString('pl-PL', {
                hour: '2-digit',
                minute: '2-digit'
            });
            var endTime = info.end.toLocaleTimeString('pl-PL', {
                hour: '2-digit',
                minute: '2-digit'
            });

            appointmentDetailsEl.innerHTML = `
                <div><strong>Data:</strong> ${startDate}</div>
                <div><strong>Godzina rozpoczęcia:</strong> ${startTime}</div>
                <div><strong>Godzina zakończenia:</strong> ${endTime}</div>
            `;

            confirmationModal.style.display = "block";
        }

        // Funkcja do zamykania modalu potwierdzenia
        function closeConfirmationModal() {
            confirmationModal.style.display = "none";
            appointmentToAdd = null;
        }

        // Funkcja do obsługi wyboru daty
        function handleDateSelection(info) {
            showConfirmationModal(info);
        }

        // Funkcja do dodawania terminu do bazy
        function addAppointment(info) {
            fetch('/instructor/add_appointment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start: info.start.toISOString(),
                    end: info.end.toISOString()
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    calendar.refetchEvents();
                    if (typeof showToast === 'function') {
                        showToast('Termin został pomyślnie dodany.', 'success');
                    } else {
                        // Własne powiadomienie o sukcesie
                        var successNotification = document.createElement('div');
                        successNotification.className = 'notification success';
                        successNotification.innerHTML = 'Termin został pomyślnie dodany.';
                        document.body.appendChild(successNotification);

                        setTimeout(function() {
                            document.body.removeChild(successNotification);
                        }, 3000);
                    }
                } else {
                    if (typeof showToast === 'function') {
                        showToast('Błąd podczas dodawania terminu: ' + (data.message || 'Nieznany błąd.'), 'error');
                    } else {
                        // Własne powiadomienie o błędzie
                        var errorNotification = document.createElement('div');
                        errorNotification.className = 'notification error';
                        errorNotification.innerHTML = 'Błąd podczas dodawania terminu: ' + (data.message || 'Nieznany błąd.');
                        document.body.appendChild(errorNotification);

                        setTimeout(function() {
                            document.body.removeChild(errorNotification);
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showToast === 'function') {
                    showToast('Wystąpił błąd podczas dodawania terminu.', 'error');
                } else {
                    // Własne powiadomienie o błędzie
                    var errorNotification = document.createElement('div');
                    errorNotification.className = 'notification error';
                    errorNotification.innerHTML = 'Wystąpił błąd podczas dodawania terminu.';
                    document.body.appendChild(errorNotification);

                    setTimeout(function() {
                        document.body.removeChild(errorNotification);
                    }, 3000);
                }
            });
        }

        // Funkcja do pokazywania modalu wyboru czasu
        function showTimeSelectModal(date) {
            selectedDate = date;
            var formattedDate = date.toLocaleDateString('pl-PL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            selectedDateEl.textContent = "Wybrany dzień: " + formattedDate;

            // Upewnij się, że godzina końcowa jest zawsze później niż początkowa
            startTimeSelect.onchange = function() {
                // Pobierz index wybranej opcji z godziny początkowej
                var startOptionIndex = startTimeSelect.selectedIndex;

                // Ustaw opcję godziny końcowej o jeden większą
                var minEndOptionIndex = startOptionIndex + 1;

                // Jeśli minEndOptionIndex jest poza zakresem, użyj ostatniej opcji
                if (minEndOptionIndex >= endTimeSelect.options.length) {
                    minEndOptionIndex = endTimeSelect.options.length - 1;
                }

                // Jeśli wybrana godzina końcowa jest wcześniejsza niż minimalna, ustaw ją na minimalną
                if (endTimeSelect.selectedIndex < minEndOptionIndex) {
                    endTimeSelect.selectedIndex = minEndOptionIndex;
                }
            };

            // Wywołaj onchange raz, aby ustawić prawidłową wartość początkową
            startTimeSelect.onchange();

            timeSelectModal.style.display = "block";
        }

        // Funkcja do zamykania modalu wyboru czasu
        function closeTimeSelectModal() {
            timeSelectModal.style.display = "none";
        }

        // Obsługa przycisków modalu wyboru czasu
        cancelButton.onclick = closeTimeSelectModal;

        // Obsługa przycisków modalu potwierdzenia
        cancelAppointmentButton.onclick = closeConfirmationModal;

        // Funkcja do faktycznego dodania terminu
        confirmAppointmentButton.onclick = function() {
            if (!appointmentToAdd) return;

            addAppointment(appointmentToAdd);
            closeConfirmationModal();
        };

        confirmButton.onclick = function() {
            // Pobierz wybrane godziny
            var startTime = startTimeSelect.value;
            var endTime = endTimeSelect.value;

            // Utwórz obiekty Date z wybraną datą i godzinami
            var startDateTime = new Date(selectedDate);
            var [startHours, startMinutes] = startTime.split(':').map(Number);
            startDateTime.setHours(startHours, startMinutes, 0, 0);

            var endDateTime = new Date(selectedDate);
            var [endHours, endMinutes] = endTime.split(':').map(Number);
            endDateTime.setHours(endHours, endMinutes, 0, 0);

            // Sprawdź, czy wybrane daty są w przyszłości
            var now = new Date();
            var oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);

            if (startDateTime < oneHourFromNow) {
                // Powiadomienie zamiast alert
                var errorNotification = document.createElement('div');
                errorNotification.className = 'notification error';
                errorNotification.innerHTML = 'Termin musi być co najmniej godzinę od teraz.';
                document.body.appendChild(errorNotification);

                setTimeout(function() {
                    document.body.removeChild(errorNotification);
                }, 3000);
                return;
            }

            // Dodaj termin - wywołaj funkcję handleDateSelection
            handleDateSelection({
                start: startDateTime,
                end: endDateTime
            });

            // Zamknij modal wyboru czasu
            closeTimeSelectModal();
        };

        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            slotDuration: '00:30:00',
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            locale: 'pl',
            timeZone: 'Europe/Warsaw',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/instructor/get_appointments',
            eventClick: function(info) {
                // Create extended props object if it doesn't exist
                info.event.extendedProps = info.event.extendedProps || {};

                // Add student name from the event data
                info.event.extendedProps.student = info.event.extendedProps.student || "";

                // Now pass the event to showAppointmentDetails
                showAppointmentDetails(info.event);
            },
            selectable: true,
            selectAllow: function(selectInfo) {
                var now = new Date();
                var oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);

                var isFullDay = selectInfo.allDay ||
                    (selectInfo.start.getHours() === 0 && selectInfo.start.getMinutes() === 0 &&
                     selectInfo.end.getHours() === 23 && selectInfo.end.getMinutes() === 59);

                if (isFullDay) {
                    var existingEvents = calendar.getEvents().filter(function(event) {
                        return event.start.toDateString() === selectInfo.start.toDateString();
                    });

                    if (existingEvents.length > 0) {
                        return false;
                    }
                }

                return selectInfo.start >= oneHourFromNow;
            },
            select: function(info) {
                // Sprawdź, czy to jest widok miesiąca
                if (calendar.view.type === 'dayGridMonth') {
                    // Pokaż modal do wyboru godzin
                    showTimeSelectModal(info.start);
                } else {
                    // Dla innych widoków, użyj standardowej funkcji
                    handleDateSelection(info);
                }
            },
            eventColor: 'green',
            eventDidMount: function(info) {
                // Add student data to the event object
                if (info.event.extendedProps && info.event.extendedProps.student) {
                    const studentEl = document.createElement('div');
                    studentEl.className = 'fc-event-student';
                    studentEl.innerText = 'Student: ' + info.event.extendedProps.student;
                    info.el.appendChild(studentEl);
                }
            }
        });
        calendar.render();
    });

    // Funkcja showAppointmentDetails - zakładam, że jest zdefiniowana gdzie indziej
    function showAppointmentDetails(event) {
        // Jeśli funkcja nie istnieje, stwórz pustą funkcję
        if (typeof window.showAppointmentDetails !== 'function') {
            window.showAppointmentDetails = function(event) {
                console.log("Event details:", event);

                // Stwórz modal zamiast alert
                var detailsModal = document.createElement('div');
                detailsModal.className = 'custom-modal';
                detailsModal.style.display = 'block';

                detailsModal.innerHTML = `
                    <div class="modal-content">
                        <h2 class="modal-title text-xl">Szczegóły terminu</h2>
                        <div class="date-time-info">
                            <div><strong>Start:</strong> ${event.start.toLocaleString()}</div>
                            <div><strong>Koniec:</strong> ${event.end.toLocaleString()}</div>
                            ${event.extendedProps.student ? `<div><strong>Student:</strong> ${event.extendedProps.student}</div>` : ''}
                        </div>
                        <div class="modal-buttons">
                            <button class="btn-confirm">Zamknij</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(detailsModal);

                var closeButton = detailsModal.querySelector('button');
                closeButton.onclick = function() {
                    document.body.removeChild(detailsModal);
                };
            };
        }

        // Wywołaj funkcję
        window.showAppointmentDetails(event);
    }
</script>
{% endblock %}